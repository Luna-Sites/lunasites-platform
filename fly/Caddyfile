{
    # Fly handles external TLS, Caddy handles internal
    auto_https off

    # Enable on-demand TLS for custom domains
    on_demand_tls {
        ask http://localhost:8081/check
    }

    # Souin cache configuration
    order cache before rewrite
    cache {
        ttl 86400s
        stale 3600s
        api {
            basepath /cache
            souin
        }
    }
}

# Health check endpoint for on-demand TLS verification
:8081 {
    respond /check 200
}

# Main HTTPS handler (Fly terminates external TLS, forwards to 8080)
:8080 {
    # Cache API for purge (protected with token)
    @cache_api {
        path /cache/*
        header Authorization "Bearer {$PURGE_SECRET}"
    }
    handle @cache_api {
        cache
    }

    # Reject unauthorized cache API requests
    @cache_api_unauth {
        path /cache/*
    }
    handle @cache_api_unauth {
        respond "Unauthorized" 401
    }

    # Cache all images (@@download and @@images)
    @images {
        path_regexp images .*@@(images|download).*
    }
    handle @images {
        cache
        reverse_proxy https://lunacms-worker.onrender.com {
            header_up Host lunacms-worker.onrender.com
            header_up X-Original-Host {host}
            header_up X-Forwarded-Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # All other requests - no cache
    handle {
        reverse_proxy https://lunacms-worker.onrender.com {
            header_up Host lunacms-worker.onrender.com
            header_up X-Original-Host {host}
            header_up X-Forwarded-Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }
}
